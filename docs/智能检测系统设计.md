# 智能检测系统设计

## 设计目标

让一个命令自动适配不同语言、框架、构建工具，无需用户手动指定。

**核心理念**：
- 用户只需运行 `/gclm:review`，系统自动检测语言并应用对应规则
- 用户只需运行 `/gclm:test`，系统自动检测测试框架并运行
- 用户只需运行 `/gclm:fix`，系统自动检测构建工具并修复

---

## 检测器模块

### 模块结构

```javascript
// src/detector.js

module.exports = {
  detectProject,        // 综合检测（入口）
  detectLanguages,      // 检测语言
  detectFrameworks,     // 检测框架
  detectBuildTools,     // 检测构建工具
  detectTestFrameworks, // 检测测试框架
  getCachedDetection,   // 获取缓存
  saveDetectionCache    // 保存缓存
};
```

---

## 语言检测

### 检测规则

| 语言 | 检测文件 | 置信度 |
|------|----------|--------|
| Java | `pom.xml`, `build.gradle` | 1.0 |
| Python | `requirements.txt`, `pyproject.toml`, `setup.py` | 1.0 |
| Go | `go.mod` | 1.0 |
| Rust | `Cargo.toml` | 1.0 |
| TypeScript | `package.json` + `tsconfig.json` | 1.0 |
| JavaScript | `package.json`（无 tsconfig.json） | 0.9 |

### 实现代码

```javascript
/**
 * 检测项目使用的编程语言
 * @param {string} projectRoot - 项目根目录
 * @returns {Array<{language: string, confidence: number, files: string[]}>}
 */
function detectLanguages(projectRoot) {
  const detections = [];

  // Java 检测
  if (hasFile(projectRoot, 'pom.xml') || hasFile(projectRoot, 'build.gradle')) {
    const files = [];
    if (hasFile(projectRoot, 'pom.xml')) files.push('pom.xml');
    if (hasFile(projectRoot, 'build.gradle')) files.push('build.gradle');
    detections.push({ language: 'java', confidence: 1.0, files });
  }

  // Python 检测
  if (hasFile(projectRoot, 'requirements.txt') ||
      hasFile(projectRoot, 'pyproject.toml') ||
      hasFile(projectRoot, 'setup.py')) {
    const files = [];
    if (hasFile(projectRoot, 'requirements.txt')) files.push('requirements.txt');
    if (hasFile(projectRoot, 'pyproject.toml')) files.push('pyproject.toml');
    if (hasFile(projectRoot, 'setup.py')) files.push('setup.py');
    detections.push({ language: 'python', confidence: 1.0, files });
  }

  // Go 检测
  if (hasFile(projectRoot, 'go.mod')) {
    detections.push({ language: 'go', confidence: 1.0, files: ['go.mod'] });
  }

  // Rust 检测
  if (hasFile(projectRoot, 'Cargo.toml')) {
    detections.push({ language: 'rust', confidence: 1.0, files: ['Cargo.toml'] });
  }

  // TypeScript/JavaScript 检测
  if (hasFile(projectRoot, 'package.json')) {
    const isTypeScript = hasFile(projectRoot, 'tsconfig.json');
    detections.push({
      language: isTypeScript ? 'typescript' : 'javascript',
      confidence: isTypeScript ? 1.0 : 0.9,
      files: ['package.json']
    });
  }

  // 按置信度排序
  return detections.sort((a, b) => b.confidence - a.confidence);
}
```

---

## 框架检测

### 检测规则

| 语言 | 框架 | 检测方式 |
|------|------|----------|
| Java | Spring Boot | `pom.xml` 中有 spring-boot 依赖，或存在 `application.yml/properties` |
| Python | FastAPI | `requirements.txt` 中有 fastapi |
| Python | Flask | `requirements.txt` 中有 flask |
| Python | Django | `requirements.txt` 中有 django，或存在 `manage.py` |
| Go | Gin | `go.mod` 中有 github.com/gin-gonic/gin |
| Go | Echo | `go.mod` 中有 github.com/labstack/echo |
| Rust | Axum | `Cargo.toml` 中有 axum |
| Rust | Actix | `Cargo.toml` 中有 actix-web |
| TypeScript | Next.js | `package.json` 中有 next |
| TypeScript | React | `package.json` 中有 react |
| TypeScript | Vue | `package.json` 中有 vue |

### 实现代码

```javascript
/**
 * 检测项目使用的框架
 * @param {string} projectRoot - 项目根目录
 * @param {string} language - 已检测的语言
 * @returns {Array<{framework: string, type: string}>}
 */
function detectFrameworks(projectRoot, language) {
  const frameworks = [];

  switch (language) {
    case 'java':
      // Spring Boot 检测
      if (hasDependency(projectRoot, 'pom.xml', 'spring-boot') ||
          hasDependency(projectRoot, 'build.gradle', 'spring-boot') ||
          hasFile(projectRoot, 'src/main/resources/application.yml') ||
          hasFile(projectRoot, 'src/main/resources/application.properties')) {
        frameworks.push({ framework: 'springboot', type: 'backend' });
      }
      break;

    case 'python':
      const requirements = readFile(projectRoot, 'requirements.txt') || '';
      const pyproject = readFile(projectRoot, 'pyproject.toml') || '';
      const deps = requirements + pyproject;

      if (deps.includes('fastapi')) {
        frameworks.push({ framework: 'fastapi', type: 'backend' });
      }
      if (deps.includes('flask')) {
        frameworks.push({ framework: 'flask', type: 'backend' });
      }
      if (deps.includes('django') || hasFile(projectRoot, 'manage.py')) {
        frameworks.push({ framework: 'django', type: 'backend' });
      }
      break;

    case 'go':
      const goMod = readFile(projectRoot, 'go.mod') || '';

      if (goMod.includes('github.com/gin-gonic/gin')) {
        frameworks.push({ framework: 'gin', type: 'backend' });
      }
      if (goMod.includes('github.com/labstack/echo')) {
        frameworks.push({ framework: 'echo', type: 'backend' });
      }
      if (goMod.includes('github.com/gofiber/fiber')) {
        frameworks.push({ framework: 'fiber', type: 'backend' });
      }
      break;

    case 'rust':
      const cargoToml = readFile(projectRoot, 'Cargo.toml') || '';

      if (cargoToml.includes('axum')) {
        frameworks.push({ framework: 'axum', type: 'backend' });
      }
      if (cargoToml.includes('actix-web')) {
        frameworks.push({ framework: 'actix', type: 'backend' });
      }
      if (cargoToml.includes('rocket')) {
        frameworks.push({ framework: 'rocket', type: 'backend' });
      }
      break;

    case 'typescript':
    case 'javascript':
      const packageJson = readJson(projectRoot, 'package.json');
      const deps = { ...packageJson.dependencies, ...packageJson.devDependencies };

      if (deps['next']) {
        frameworks.push({ framework: 'nextjs', type: 'frontend' });
      }
      if (deps['react'] && !deps['next']) {
        frameworks.push({ framework: 'react', type: 'frontend' });
      }
      if (deps['vue']) {
        frameworks.push({ framework: 'vue', type: 'frontend' });
      }
      if (deps['express']) {
        frameworks.push({ framework: 'express', type: 'backend' });
      }
      if (deps['nestjs'] || deps['@nestjs/core']) {
        frameworks.push({ framework: 'nestjs', type: 'backend' });
      }
      break;
  }

  return frameworks;
}
```

---

## 构建工具检测

### 检测规则

| 语言 | 构建工具 | 检测文件 |
|------|----------|----------|
| Java | Maven | `pom.xml` |
| Java | Gradle | `build.gradle` |
| Python | Poetry | `pyproject.toml`（含 poetry 配置） |
| Python | Pip | `requirements.txt` |
| Go | go mod | `go.mod` |
| Rust | Cargo | `Cargo.toml` |
| TypeScript/JS | npm/pnpm/yarn | `package.json` + lock 文件 |

### 实现代码

```javascript
/**
 * 检测项目使用的构建工具
 * @param {string} projectRoot - 项目根目录
 * @param {string} language - 已检测的语言
 * @returns {Array<{tool: string, commands: object}>}
 */
function detectBuildTools(projectRoot, language) {
  const tools = [];

  switch (language) {
    case 'java':
      if (hasFile(projectRoot, 'pom.xml')) {
        tools.push({
          tool: 'maven',
          commands: {
            build: 'mvn compile',
            test: 'mvn test',
            package: 'mvn package',
            clean: 'mvn clean',
            lint: 'mvn checkstyle:check'
          }
        });
      }
      if (hasFile(projectRoot, 'build.gradle') || hasFile(projectRoot, 'build.gradle.kts')) {
        tools.push({
          tool: 'gradle',
          commands: {
            build: './gradlew build',
            test: './gradlew test',
            package: './gradlew jar',
            clean: './gradlew clean'
          }
        });
      }
      break;

    case 'python':
      if (hasFile(projectRoot, 'pyproject.toml')) {
        const pyproject = readFile(projectRoot, 'pyproject.toml');
        if (pyproject?.includes('[tool.poetry]')) {
          tools.push({
            tool: 'poetry',
            commands: {
              install: 'poetry install',
              test: 'poetry run pytest',
              build: 'poetry build'
            }
          });
        } else {
          tools.push({
            tool: 'pip',
            commands: {
              install: 'pip install -e .',
              test: 'pytest'
            }
          });
        }
      }
      if (hasFile(projectRoot, 'requirements.txt') && tools.length === 0) {
        tools.push({
          tool: 'pip',
          commands: {
            install: 'pip install -r requirements.txt',
            test: 'pytest'
          }
        });
      }
      break;

    case 'go':
      tools.push({
        tool: 'go-mod',
        commands: {
          build: 'go build ./...',
          test: 'go test ./...',
          fmt: 'go fmt ./...',
          vet: 'go vet ./...',
          lint: 'golangci-lint run'
        }
      });
      break;

    case 'rust':
      tools.push({
        tool: 'cargo',
        commands: {
          build: 'cargo build',
          test: 'cargo test',
          fmt: 'cargo fmt',
          lint: 'cargo clippy',
          doc: 'cargo doc'
        }
      });
      break;

    case 'typescript':
    case 'javascript':
      const packageManager = detectPackageManager(projectRoot);
      const pmCmd = packageManager === 'pnpm' ? 'pnpm' :
                    packageManager === 'yarn' ? 'yarn' :
                    packageManager === 'bun' ? 'bun' : 'npm';

      tools.push({
        tool: packageManager,
        commands: {
          install: `${pmCmd} install`,
          build: `${pmCmd} run build`,
          test: `${pmCmd} test`,
          lint: `${pmCmd} run lint`,
          fmt: `${pmCmd} run format`
        }
      });
      break;
  }

  return tools;
}

/**
 * 检测包管理器
 */
function detectPackageManager(projectRoot) {
  if (hasFile(projectRoot, 'pnpm-lock.yaml')) return 'pnpm';
  if (hasFile(projectRoot, 'yarn.lock')) return 'yarn';
  if (hasFile(projectRoot, 'bun.lockb')) return 'bun';
  if (hasFile(projectRoot, 'package-lock.json')) return 'npm';
  return 'npm'; // 默认
}
```

---

## 测试框架检测

### 检测规则

| 语言 | 测试框架 | 检测方式 |
|------|----------|----------|
| Java | JUnit 5 | `pom.xml` 中有 junit |
| Java | TestNG | `pom.xml` 中有 testng |
| Python | pytest | `requirements.txt` 中有 pytest |
| Python | unittest | 标准库，默认支持 |
| Go | go test | 标准库，默认支持 |
| Rust | cargo test | 标准库，默认支持 |
| TypeScript | Jest | `package.json` 中有 jest |
| TypeScript | Vitest | `package.json` 中有 vitest |
| TypeScript | Playwright | `package.json` 中有 @playwright/test |

### 实现代码

```javascript
/**
 * 检测项目使用的测试框架
 * @param {string} projectRoot - 项目根目录
 * @param {string} language - 已检测的语言
 * @returns {Array<{framework: string, commands: object}>}
 */
function detectTestFrameworks(projectRoot, language) {
  const frameworks = [];

  switch (language) {
    case 'java':
      const pomXml = readFile(projectRoot, 'pom.xml') || '';
      if (pomXml.includes('junit') || pomXml.includes('JUnit')) {
        frameworks.push({
          framework: 'junit5',
          commands: {
            test: 'mvn test',
            coverage: 'mvn jacoco:report'
          }
        });
      }
      if (pomXml.includes('testng')) {
        frameworks.push({
          framework: 'testng',
          commands: { test: 'mvn test' }
        });
      }
      break;

    case 'python':
      const requirements = readFile(projectRoot, 'requirements.txt') || '';
      const pyproject = readFile(projectRoot, 'pyproject.toml') || '';
      const deps = requirements + pyproject;

      if (deps.includes('pytest')) {
        frameworks.push({
          framework: 'pytest',
          commands: {
            test: 'pytest',
            coverage: 'pytest --cov --cov-report=html',
            watch: 'pytest-watch'
          }
        });
      }
      // unittest 是标准库，始终可用
      frameworks.push({
        framework: 'unittest',
        commands: { test: 'python -m unittest discover' }
      });
      break;

    case 'go':
      frameworks.push({
        framework: 'go-test',
        commands: {
          test: 'go test ./...',
          coverage: 'go test -coverprofile=coverage.out ./... && go tool cover -html=coverage.out',
          race: 'go test -race ./...',
          bench: 'go test -bench=. ./...'
        }
      });
      break;

    case 'rust':
      frameworks.push({
        framework: 'cargo-test',
        commands: {
          test: 'cargo test',
          coverage: 'cargo llvm-cov --html',
          doc: 'cargo test --doc'
        }
      });
      break;

    case 'typescript':
    case 'javascript':
      const packageJson = readJson(projectRoot, 'package.json');
      const deps = { ...packageJson.dependencies, ...packageJson.devDependencies };

      if (deps['vitest']) {
        frameworks.push({
          framework: 'vitest',
          commands: {
            test: 'vitest run',
            coverage: 'vitest run --coverage',
            watch: 'vitest'
          }
        });
      }
      if (deps['jest']) {
        frameworks.push({
          framework: 'jest',
          commands: {
            test: 'jest',
            coverage: 'jest --coverage',
            watch: 'jest --watch'
          }
        });
      }
      if (deps['@playwright/test']) {
        frameworks.push({
          framework: 'playwright',
          commands: {
            test: 'playwright test',
            ui: 'playwright test --ui'
          }
        });
      }
      if (deps['cypress']) {
        frameworks.push({
          framework: 'cypress',
          commands: {
            test: 'cypress run',
            open: 'cypress open'
          }
        });
      }
      break;
  }

  return frameworks;
}
```

---

## 综合检测入口

```javascript
/**
 * 综合检测项目环境
 * @param {string} projectRoot - 项目根目录
 * @param {boolean} useCache - 是否使用缓存
 * @returns {object} 检测结果
 */
function detectProject(projectRoot, useCache = true) {
  // 检查缓存
  if (useCache) {
    const cached = getCachedDetection(projectRoot);
    if (cached) return cached;
  }

  // 检测语言
  const languages = detectLanguages(projectRoot);

  // 对每种语言检测框架、构建工具、测试框架
  const result = {
    languages,
    frameworks: [],
    buildTools: [],
    testFrameworks: [],
    isMonorepo: detectMonorepo(projectRoot),
    detectedAt: new Date().toISOString()
  };

  for (const lang of languages) {
    result.frameworks.push(...detectFrameworks(projectRoot, lang.language));
    result.buildTools.push(...detectBuildTools(projectRoot, lang.language));
    result.testFrameworks.push(...detectTestFrameworks(projectRoot, lang.language));
  }

  // 保存缓存
  saveDetectionCache(projectRoot, result);

  return result;
}
```

---

## 检测结果数据结构

```javascript
{
  "languages": [
    { "language": "java", "confidence": 1.0, "files": ["pom.xml"] }
  ],
  "frameworks": [
    { "framework": "springboot", "type": "backend" }
  ],
  "buildTools": [
    {
      "tool": "maven",
      "commands": {
        "build": "mvn compile",
        "test": "mvn test",
        "package": "mvn package",
        "clean": "mvn clean"
      }
    }
  ],
  "testFrameworks": [
    {
      "framework": "junit5",
      "commands": {
        "test": "mvn test",
        "coverage": "mvn jacoco:report"
      }
    }
  ],
  "isMonorepo": false,
  "detectedAt": "2026-02-25T15:00:00Z"
}
```

---

## 在命令中使用

### /gclm:review 命令 - 执行流程

1. **检测项目环境**
   ```javascript
   const projectInfo = detectProject(projectRoot);
   ```

2. **加载对应的 Skills**
   ```javascript
   const skillsToLoad = [];

   // 加载语言特定 skills
   for (const lang of projectInfo.languages) {
     skillsToLoad.push(`skills/patterns/${lang.language}/`);
   }

   // 加载框架特定 skills
   for (const fw of projectInfo.frameworks) {
     skillsToLoad.push(`skills/patterns/${fw.framework}/`);
   }
   ```

3. **执行审查**
   - 应用通用审查规则
   - 应用语言特定规则
   - 应用框架特定规则

### /gclm:test 命令 - 执行流程

1. **检测测试框架**
   ```javascript
   const projectInfo = detectProject(projectRoot);
   const testFramework = projectInfo.testFrameworks[0];
   ```

2. **选择并执行命令**
   ```javascript
   const testCommand = testFramework.commands.test;
   await runCommand(testCommand);
   ```

3. **分析结果**
   - 解析测试输出
   - 识别失败用例
   - 提供修复建议

### /gclm:fix 命令 - 执行流程


1. **检测构建工具**
   ```javascript
   const projectInfo = detectProject(projectRoot);
   const buildTool = projectInfo.buildTools[0];
   ```

2. **运行构建获取错误**
   ```javascript
   const buildCommand = buildTool.commands.build;
   const output = await runCommand(buildCommand);
   const errors = parseBuildErrors(output, projectInfo.languages[0].language);
   ```

3. **修复错误**
   - 根据错误类型应用修复策略
   - 引用 skills 中的错误处理模式

---

## 缓存机制

### 存储策略

缓存采用**双层存储**策略，所有 gclm-flow 数据统一存储在 `~/.gclm-flow/` 目录下：

| 位置 | 文件 | 用途 |
|------|------|------|
| 项目本地 | `项目根目录/.gclm/detection.json` | 当前项目的检测结果 |
| 全局索引 | `~/.gclm-flow/cache/projects.json` | 所有项目的索引（便于管理和查询） |

### 目录结构

```
~/.gclm-flow/
├── memory/                        # 记忆系统
│   ├── errors/
│   ├── patterns/
│   └── index.json
│
├── cache/                         # 缓存系统
│   └── projects.json              # 项目检测缓存索引
│
└── config.json                    # gclm-flow 全局配置
```

### 项目本地缓存

#### 缓存文件位置

```
项目根目录/.gclm/detection.json
```

#### 缓存结果示例

**Java/Spring Boot 项目**

```json
{
  "project": {
    "name": "user-service",
    "path": "/Users/gclm/Projects/user-service",
    "type": "backend"
  },
  "languages": [
    {
      "language": "java",
      "confidence": 1.0,
      "files": ["pom.xml"]
    }
  ],
  "frameworks": [
    {
      "framework": "springboot",
      "type": "backend"
    }
  ],
  "buildTools": [
    {
      "tool": "maven",
      "commands": {
        "build": "mvn compile",
        "test": "mvn test",
        "package": "mvn package",
        "clean": "mvn clean",
        "lint": "mvn checkstyle:check"
      }
    }
  ],
  "testFrameworks": [
    {
      "framework": "junit5",
      "commands": {
        "test": "mvn test",
        "coverage": "mvn jacoco:report"
      }
    }
  ],
  "isMonorepo": false,
  "detectedAt": "2026-02-25T15:00:00Z",
  "version": "1.0"
}
```

**Python/FastAPI 项目**

```json
{
  "project": {
    "name": "api-gateway",
    "path": "/Users/gclm/Projects/api-gateway",
    "type": "backend"
  },
  "languages": [
    {
      "language": "python",
      "confidence": 1.0,
      "files": ["pyproject.toml", "requirements.txt"]
    }
  ],
  "frameworks": [
    {
      "framework": "fastapi",
      "type": "backend"
    }
  ],
  "buildTools": [
    {
      "tool": "poetry",
      "commands": {
        "install": "poetry install",
        "test": "poetry run pytest",
        "build": "poetry build"
      }
    }
  ],
  "testFrameworks": [
    {
      "framework": "pytest",
      "commands": {
        "test": "pytest",
        "coverage": "pytest --cov --cov-report=html",
        "watch": "pytest-watch"
      }
    }
  ],
  "isMonorepo": false,
  "detectedAt": "2026-02-25T15:30:00Z",
  "version": "1.0"
}
```

**Go/Gin 项目**

```json
{
  "project": {
    "name": "order-service",
    "path": "/Users/gclm/Projects/order-service",
    "type": "backend"
  },
  "languages": [
    {
      "language": "go",
      "confidence": 1.0,
      "files": ["go.mod"]
    }
  ],
  "frameworks": [
    {
      "framework": "gin",
      "type": "backend"
    }
  ],
  "buildTools": [
    {
      "tool": "go-mod",
      "commands": {
        "build": "go build ./...",
        "test": "go test ./...",
        "fmt": "go fmt ./...",
        "vet": "go vet ./...",
        "lint": "golangci-lint run"
      }
    }
  ],
  "testFrameworks": [
    {
      "framework": "go-test",
      "commands": {
        "test": "go test ./...",
        "coverage": "go test -coverprofile=coverage.out ./... && go tool cover -html=coverage.out",
        "race": "go test -race ./...",
        "bench": "go test -bench=. ./..."
      }
    }
  ],
  "isMonorepo": false,
  "detectedAt": "2026-02-25T16:00:00Z",
  "version": "1.0"
}
```

**Rust/Axum 项目**

```json
{
  "project": {
    "name": "auth-service",
    "path": "/Users/gclm/Projects/auth-service",
    "type": "backend"
  },
  "languages": [
    {
      "language": "rust",
      "confidence": 1.0,
      "files": ["Cargo.toml"]
    }
  ],
  "frameworks": [
    {
      "framework": "axum",
      "type": "backend"
    }
  ],
  "buildTools": [
    {
      "tool": "cargo",
      "commands": {
        "build": "cargo build",
        "test": "cargo test",
        "fmt": "cargo fmt",
        "lint": "cargo clippy",
        "doc": "cargo doc"
      }
    }
  ],
  "testFrameworks": [
    {
      "framework": "cargo-test",
      "commands": {
        "test": "cargo test",
        "coverage": "cargo llvm-cov --html",
        "doc": "cargo test --doc"
      }
    }
  ],
  "isMonorepo": false,
  "detectedAt": "2026-02-25T16:30:00Z",
  "version": "1.0"
}
```

**前端项目（TypeScript/React）**

```json
{
  "project": {
    "name": "admin-dashboard",
    "path": "/Users/gclm/Projects/admin-dashboard",
    "type": "frontend"
  },
  "languages": [
    {
      "language": "typescript",
      "confidence": 1.0,
      "files": ["package.json"]
    }
  ],
  "frameworks": [
    {
      "framework": "react",
      "type": "frontend"
    }
  ],
  "buildTools": [
    {
      "tool": "pnpm",
      "commands": {
        "install": "pnpm install",
        "build": "pnpm run build",
        "test": "pnpm test",
        "lint": "pnpm run lint",
        "fmt": "pnpm run format"
      }
    }
  ],
  "testFrameworks": [
    {
      "framework": "vitest",
      "commands": {
        "test": "vitest run",
        "coverage": "vitest run --coverage",
        "watch": "vitest"
      }
    }
  ],
  "isMonorepo": false,
  "detectedAt": "2026-02-25T17:00:00Z",
  "version": "1.0"
}
```

**全栈项目（Java + TypeScript）**

```json
{
  "project": {
    "name": "ecommerce-platform",
    "path": "/Users/gclm/Projects/ecommerce-platform",
    "type": "fullstack"
  },
  "languages": [
    {
      "language": "java",
      "confidence": 1.0,
      "files": ["pom.xml"]
    },
    {
      "language": "typescript",
      "confidence": 1.0,
      "files": ["package.json"]
    }
  ],
  "frameworks": [
    {
      "framework": "springboot",
      "type": "backend"
    },
    {
      "framework": "react",
      "type": "frontend"
    }
  ],
  "buildTools": [
    {
      "tool": "maven",
      "commands": {
        "build": "mvn compile",
        "test": "mvn test",
        "package": "mvn package"
      }
    },
    {
      "tool": "npm",
      "commands": {
        "install": "npm install",
        "build": "npm run build",
        "test": "npm test"
      }
    }
  ],
  "testFrameworks": [
    {
      "framework": "junit5",
      "commands": {
        "test": "mvn test"
      }
    },
    {
      "framework": "vitest",
      "commands": {
        "test": "vitest run"
      }
    }
  ],
  "isMonorepo": false,
  "detectedAt": "2026-02-25T17:30:00Z",
  "version": "1.0"
}
```

### 全局索引

#### 索引文件位置

```
~/.gclm-flow/cache/projects.json
```

#### 索引结构

```json
{
  "version": "1.0",
  "lastUpdated": "2026-02-25T18:00:00Z",
  "projects": [
    {
      "name": "user-service",
      "path": "/Users/gclm/Projects/user-service",
      "type": "backend",
      "primaryLanguage": "java",
      "primaryFramework": "springboot",
      "lastAccessed": "2026-02-25T15:00:00Z"
    },
    {
      "name": "api-gateway",
      "path": "/Users/gclm/Projects/api-gateway",
      "type": "backend",
      "primaryLanguage": "python",
      "primaryFramework": "fastapi",
      "lastAccessed": "2026-02-25T15:30:00Z"
    },
    {
      "name": "order-service",
      "path": "/Users/gclm/Projects/order-service",
      "type": "backend",
      "primaryLanguage": "go",
      "primaryFramework": "gin",
      "lastAccessed": "2026-02-25T16:00:00Z"
    },
    {
      "name": "auth-service",
      "path": "/Users/gclm/Projects/auth-service",
      "type": "backend",
      "primaryLanguage": "rust",
      "primaryFramework": "axum",
      "lastAccessed": "2026-02-25T16:30:00Z"
    },
    {
      "name": "admin-dashboard",
      "path": "/Users/gclm/Projects/admin-dashboard",
      "type": "frontend",
      "primaryLanguage": "typescript",
      "primaryFramework": "react",
      "lastAccessed": "2026-02-25T17:00:00Z"
    },
    {
      "name": "ecommerce-platform",
      "path": "/Users/gclm/Projects/ecommerce-platform",
      "type": "fullstack",
      "primaryLanguage": "java",
      "primaryFramework": "springboot",
      "lastAccessed": "2026-02-25T17:30:00Z"
    }
  ],
  "stats": {
    "totalProjects": 6,
    "byLanguage": {
      "java": 2,
      "python": 1,
      "go": 1,
      "rust": 1,
      "typescript": 1
    },
    "byType": {
      "backend": 4,
      "frontend": 1,
      "fullstack": 1
    }
  }
}
```

### 缓存实现

```javascript
const CACHE_FILE = '.gclm/detection.json';
const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 小时

/**
 * 获取缓存的检测结果
 */
function getCachedDetection(projectRoot) {
  const cachePath = path.join(projectRoot, CACHE_FILE);

  if (!fs.existsSync(cachePath)) {
    return null;
  }

  try {
    const cache = JSON.parse(fs.readFileSync(cachePath, 'utf8'));
    const cacheAge = Date.now() - new Date(cache.detectedAt).getTime();

    // 检查缓存是否过期
    if (cacheAge > CACHE_TTL) {
      return null;
    }

    // 检查关键文件是否被修改
    const keyFiles = getKeyFiles(cache);
    for (const file of keyFiles) {
      const filePath = path.join(projectRoot, file);
      if (fs.existsSync(filePath)) {
        const stat = fs.statSync(filePath);
        if (stat.mtimeMs > new Date(cache.detectedAt).getTime()) {
          return null; // 文件已修改，缓存失效
        }
      }
    }

    return cache;
  } catch {
    return null;
  }
}

/**
 * 保存检测结果到缓存
 */
function saveDetectionCache(projectRoot, detection) {
  const cachePath = path.join(projectRoot, CACHE_FILE);
  const cacheDir = path.dirname(cachePath);

  fs.ensureDirSync(cacheDir);
  fs.writeFileSync(cachePath, JSON.stringify(detection, null, 2));
}

/**
 * 获取关键文件列表（用于检查缓存有效性）
 */
function getKeyFiles(detection) {
  const files = [];

  for (const lang of detection.languages) {
    files.push(...lang.files);
  }

  return files;
}
```

### 强制刷新

```bash
# 用户可以强制刷新检测
/gclm:review --refresh
/gclm:test --refresh
```

---

## 工具函数

```javascript
/**
 * 检查文件是否存在
 */
function hasFile(projectRoot, filename) {
  return fs.existsSync(path.join(projectRoot, filename));
}

/**
 * 读取文件内容
 */
function readFile(projectRoot, filename) {
  const filePath = path.join(projectRoot, filename);
  if (!fs.existsSync(filePath)) return null;
  return fs.readFileSync(filePath, 'utf8');
}

/**
 * 读取 JSON 文件
 */
function readJson(projectRoot, filename) {
  const content = readFile(projectRoot, filename);
  if (!content) return {};
  try {
    return JSON.parse(content);
  } catch {
    return {};
  }
}

/**
 * 检查依赖是否存在
 */
function hasDependency(projectRoot, filename, dependency) {
  const content = readFile(projectRoot, filename);
  if (!content) return false;
  return content.toLowerCase().includes(dependency.toLowerCase());
}

/**
 * 检测是否为 Monorepo
 */
function detectMonorepo(projectRoot) {
  // 检查常见 monorepo 标志
  const packageJson = readJson(projectRoot, 'package.json');

  if (packageJson.workspaces) return true;
  if (hasFile(projectRoot, 'pnpm-workspace.yaml')) return true;
  if (hasFile(projectRoot, 'lerna.json')) return true;
  if (hasFile(projectRoot, 'nx.json')) return true;
  if (hasFile(projectRoot, 'turbo.json')) return true;

  // 检查 Maven 多模块
  const pomXml = readFile(projectRoot, 'pom.xml');
  if (pomXml && pomXml.includes('<modules>')) return true;

  return false;
}
```
