# Gclm-Flow 工作流设计方案 v2

## 设计目标

创建一个**统一、简洁、智能**的全栈开发工作流系统，整合三个参考项目的精华：

| 来源 | 核心价值 |
|------|----------|
| ai-max | npm 安装系统、交互式 CLI |
| everything-claude-code | 多语言 skills、分层 rules |
| cc-plugin | llmdoc 文档系统、SDD 工作流 |

---

## 核心理念

### 1. 文档驱动一切 (llmdoc First)

**所有工作流都基于 llmdoc**：

```
llmdoc/                    # 项目知识库
├── index.md               # 导航入口
├── overview/              # 项目概述
├── architecture/          # 系统架构（LLM 检索地图）
├── guides/                # 操作指南
└── reference/             # 规范参考
```

**Context Floor 原则**：
- 做任何事之前，先读 llmdoc 建立上下文
- llmdoc 是项目的"大脑"，代码是"身体"

### 2. 统一工作流模式

**所有任务遵循相同模式**：

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  1. 理解    │ -> │  2. 规划    │ -> │  3. 执行    │ -> │  4. 记录    │
│  读llmdoc   │    │  制定方案   │    │  写代码     │    │  更新文档   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

- **TDD**: 读文档 → 规划测试 → 写测试+代码 → 记录模式
- **Code Review**: 读文档 → 分析差异 → 审查代码 → 记录问题
- **新功能**: 读文档 → 设计方案 → 实现代码 → 更新文档
- **Bug修复**: 读文档 → 定位问题 → 修复代码 → 记录教训

### 3. 智能而非硬编码

- 一个 `review` 命令，自动检测语言
- 一个 `test` 命令，自动检测框架
- 一个 `fix` 命令，自动检测构建工具

---

## 代理体系（精简为 6 个）

| 代理 | 职责 | 触发场景 |
|------|------|----------|
| **planner** | 理解需求，制定方案 | 新功能、复杂任务 |
| **builder** | 执行具体任务 | 写代码、改文件、跑命令 |
| **reviewer** | 代码审查 | 质量检查、安全审计 |
| **investigator** | 快速调查 | "这是什么"、"怎么工作的" |
| **recorder** | 维护文档 | 更新 llmdoc、记录模式 |
| **remember** | 记忆管理 | 记录错误、提取最佳实践 |

**移除的代理**：
- ❌ tdd-guide → 合并到 planner + builder
- ❌ architect → 合并到 planner
- ❌ 各语言 reviewer → 用 reviewer + 语言 skills 替代
- ❌ scout → 合并到 investigator
- ❌ worker → 重命名为 builder

---

## 命令体系（12 个）

### 核心命令

| 命令 | 描述 | 工作流 |
|------|------|--------|
| `/gclm:auto` | 智能路由 | 自动选择合适命令 |
| `/gclm:init` | 初始化项目 | 创建 llmdoc 结构 |
| `/gclm:plan` | 规划任务 | 理解→分析→方案 |
| `/gclm:do` | 执行任务 | 规划→编码→验证 |
| `/gclm:review` | 代码审查 | 差异分析→问题检测→建议 |
| `/gclm:test` | 测试相关 | 自动检测框架→运行→覆盖率 |
| `/gclm:fix` | 修复问题 | 构建错误、类型错误、lint |
| `/gclm:doc` | 文档操作 | 读/写/更新 llmdoc |
| `/gclm:ask` | 快速调查 | 代码库问答 |
| `/gclm:learn` | 学习记忆 | 记录错误、提取模式 |
| `/gclm:commit` | 提交代码 | 生成提交信息 |
| `/gclm:verify` | 设计验证 | 对照设计文档检查实现 |

### 命令参数化

```bash
# 语言指定（可选，默认自动检测）
/gclm:review --lang java
/gclm:test --lang python

# 范围指定
/gclm:review --scope security
/gclm:test --scope unit

# 模式指定
/gclm:doc --mode read     # 读取
/gclm:doc --mode update   # 更新
/gclm:doc --mode init     # 初始化
```

---

## 技能体系（按功能组织）

```
skills/
├── core/                      # 核心工作流
│   ├── plan-workflow/
│   │   └── SKILL.md
│   ├── review-workflow/
│   │   └── SKILL.md
│   ├── test-workflow/
│   │   └── SKILL.md
│   └── doc-workflow/
│       ├── SKILL.md
│       └── references/
│           ├── llmdoc-structure.md
│           └── doc-conventions.md
│
├── patterns/                  # 语言模式（按语言）
│   ├── java/
│   │   ├── springboot.md
│   │   └── testing.md
│   ├── python/
│   │   ├── fastapi.md
│   │   └── testing.md
│   ├── go/
│   │   ├── gin.md
│   │   └── testing.md
│   ├── rust/
│   │   ├── axum.md
│   │   └── testing.md
│   └── frontend/
│       ├── react.md
│       └── testing.md
│
├── database/
│   └── SKILL.md               # 数据库技能
│
├── devops/
│   └── SKILL.md               # DevOps 技能
│
└── memory/
    └── SKILL.md               # 记忆系统技能
```

---

## 规则体系（分层架构）

```
rules/
├── core.md                    # 核心规则（必装）
├── languages/
│   ├── java.md
│   ├── python.md
│   ├── go.md
│   ├── rust.md
│   └── frontend.md
└── domains/
    ├── security.md            # 安全规则
    ├── testing.md             # 测试规则
    └── performance.md         # 性能规则
```

---

## 项目结构

### 设计说明

> **命名空间隔离**：命令使用 `commands/gclm/` 结构，安装后命令前缀为 `/gclm:*`，避免与其他插件冲突。

```
gclm-flow/
├── bin/cli.js                 # CLI 入口
├── src/
│   ├── index.js               # 主逻辑
│   ├── installer.js           # 安装系统
│   ├── prompts.js             # 交互提示
│   ├── detector.js            # 语言/框架检测
│   └── utils.js               # 工具函数
│
├── agents/                    # 6 个代理
│   ├── planner.md
│   ├── builder.md
│   ├── reviewer.md
│   ├── investigator.md
│   ├── recorder.md
│   └── remember.md
│
├── commands/gclm/             # 12 个命令（命名空间：/gclm:*）
│   ├── auto.md                # /gclm:auto
│   ├── init.md                # /gclm:init
│   ├── plan.md                # /gclm:plan
│   ├── do.md                  # /gclm:do
│   ├── review.md              # /gclm:review
│   ├── test.md                # /gclm:test
│   ├── fix.md                 # /gclm:fix
│   ├── doc.md                 # /gclm:doc
│   ├── ask.md                 # /gclm:ask
│   ├── learn.md               # /gclm:learn
│   ├── commit.md              # /gclm:commit
│   └── verify.md              # /gclm:verify
│
├── skills/                    # 技能库
│   ├── core/                  # 核心工作流
│   │   ├── plan-workflow/
│   │   ├── review-workflow/
│   │   ├── test-workflow/
│   │   └── doc-workflow/
│   ├── patterns/              # 语言模式
│   │   ├── java/
│   │   ├── python/
│   │   ├── go/
│   │   ├── rust/
│   │   └── frontend/
│   ├── database/              # 数据库技能
│   ├── devops/                # DevOps 技能
│   └── memory/                # 记忆系统技能
│
├── rules/                     # 规则库
│   ├── core.md
│   ├── languages/
│   │   ├── java.md
│   │   ├── python.md
│   │   ├── go.md
│   │   ├── rust.md
│   │   └── frontend.md
│   └── domains/
│       ├── security.md
│       ├── testing.md
│       └── performance.md
│
├── hooks/
│   └── hooks.json             # Hooks 配置
│
├── templates/                 # 用户级配置模板
│   ├── user-CLAUDE.md         # 用户级 CLAUDE.md
│   ├── statusline.json        # 状态栏配置
│   └── mcp-servers.json       # MCP 服务器配置
│
├── scripts/hooks/             # Hook 脚本
│   ├── session-start.js
│   ├── session-end.js
│   ├── pre-compact.js
│   ├── post-edit-format.js
│   └── check-console-log.js
│
├── docs/                      # 设计文档
│   ├── 设计方案.md
│   ├── 记忆系统设计.md
│   └── 智能检测系统设计.md
│
├── tests/                     # 测试
│   └── installer.test.js
│
├── CLAUDE.md                  # 项目示例
├── README.md
├── package.json
└── vitest.config.js
```

---

## 安装系统

### CLI 命令

```bash
gclm-flow                    # 交互模式
gclm-flow install            # 安装
gclm-flow install -y         # 直接安装（使用默认配置）
gclm-flow update             # 更新
gclm-flow uninstall          # 卸载
gclm-flow list               # 列出组件
```

### 安装目标

```
~/.claude/                    # Claude Code 配置目录
├── agents/                   # 代理文件
├── commands/gclm/            # 命令文件 → /gclm:* 命令
├── rules/                    # 规则文件
├── skills/                   # 技能文件
├── hooks/hooks.json          # Hooks 配置
└── .gclm-version             # 版本信息

~/.gclm-flow/                 # Gclm-Flow 数据目录
├── memory/                   # 记忆系统数据
├── cache/                    # 检测缓存
└── session.json              # 会话状态
```

---

## 使用示例

### 场景 1：新功能开发

```bash
# 1. 初始化项目（首次）
/gclm:init

# 2. 规划功能
/gclm:plan 添加用户认证功能

# 3. 执行开发
/gclm:do

# 4. 测试
/gclm:test

# 5. 审查
/gclm:review

# 6. 提交
/gclm:commit
```

### 场景 2：Bug 修复

```bash
# 1. 调查问题
/gclm:ask 用户登录为什么会失败？

# 2. 修复
/gclm:fix

# 3. 记录教训
/gclm:learn 记录这个错误
```

### 场景 3：代码审查

```bash
# 自动检测语言并审查
/gclm:review

# 指定审查范围
/gclm:review --scope security
```

### 场景 4：设计验证

```bash
# 对照设计文档验证实现
/gclm:verify
```

---

## 实现进度

### Phase 1: 核心框架 ✅
- [x] 创建项目结构
- [x] 实现安装系统（基于 ai-max）
- [x] 实现语言检测器

### Phase 2: 核心代理 ✅
- [x] 实现 6 个代理
- [x] 统一代理格式

### Phase 3: 核心命令 ✅
- [x] 实现 12 个命令
- [x] 统一命令格式
- [x] 命名空间隔离（/gclm:*）

### Phase 4: 技能库 ✅
- [x] 创建 core/ 工作流技能
- [x] 重组 patterns/ 按语言分目录
- [x] 创建 database/ 技能
- [x] 创建 devops/ 技能
- [x] 创建 memory/ 技能

### Phase 5: llmdoc 系统 ✅
- [x] 实现 doc-workflow 技能
- [x] 创建 llmdoc 参考文档（非模板）

### Phase 6: 规则体系 ✅
- [x] 创建 core.md
- [x] 创建 languages/*.md
- [x] 创建 domains/*.md

### Phase 7: Hooks 系统 ✅
- [x] 创建 hooks.json
- [x] 实现 session 管理 hooks
- [x] 实现代码检查 hooks

### Phase 8: 测试与文档 ✅
- [x] 编写测试
- [x] 编写 README
- [x] 编写 CLAUDE.md 示例

---

## 记忆系统

> 详细设计见 [记忆系统设计.md](./记忆系统设计.md)

### 概要

- **错误记忆**：记录错误和解决方案，避免重复犯错
- **模式记忆**：提取成功的代码模式，促进复用
- **自动触发**：通过 hooks 在错误发生、任务完成时自动记录
- **命令**：`/gclm:learn error|pattern|search|list|stats|clean`

---

## 智能检测系统

> 详细设计见 [智能检测系统设计.md](./智能检测系统设计.md)

### 概要

- **语言检测**：通过项目文件自动识别
- **框架检测**：通过依赖文件自动识别（Spring Boot、FastAPI、Gin、Axum 等）
- **构建工具检测**：自动识别构建命令
- **测试框架检测**：自动识别测试命令（JUnit、pytest、go test、cargo test 等）
- **缓存机制**：检测结果缓存 24 小时，避免重复检测

### 使用示例

```bash
/gclm:review   # 自动检测语言 → 加载对应 skills → 执行审查
/gclm:test     # 自动检测测试框架 → 运行对应命令
/gclm:fix      # 自动检测构建工具 → 运行构建 → 修复错误
```

---

## MCP 配置

支持以下 MCP 服务器：

| MCP Server | 描述 |
|------------|------|
| auggie | Augment relay 服务 |
| playwright | 浏览器自动化测试 |
| exa | Exa 搜索服务 |

---

## 设计决策记录

### 为什么使用 `commands/gclm/` 而非 `commands/`？

Claude Code 的命令路径决定命令前缀：

```
~/.claude/commands/
├── init.md              → /init
├── gclm/
│   └── init.md          → /gclm:init
└── aimax/
    └── init.md          → /aimax:init
```

使用 `commands/gclm/` 的好处：
1. **命名空间隔离**：防止与其他插件命令冲突
2. **统一前缀**：所有命令以 `/gclm:` 开头，易于识别
3. **可扩展性**：未来可支持自定义前缀

### 为什么不使用 templates/？

采用 cc-plugin 的方式，在 `skills/doc-workflow/references/` 中提供参考文档，而非静态模板：
- **更灵活**：AI 根据项目实际情况动态生成
- **更智能**：不需要预制模板
- **更简洁**：不需要维护模板文件

---

## 版本历史

- **v2** - 2026-02-25：重构完成，结构符合设计
- **v1** - 2026-02-25：初始实现
