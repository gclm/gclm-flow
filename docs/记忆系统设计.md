# 记忆系统设计

## 设计理念

**记忆系统 = 项目的长期知识库**

- **短期记忆**：当前会话的上下文（Claude Code 自动管理）
- **长期记忆**：跨会话的知识积累（我们实现）
- **项目知识**：llmdoc（文档形式）
- **经验知识**：memory（结构化数据）

---

## 记忆类型

| 类型 | 内容 | 存储位置 | 用途 |
|------|------|----------|------|
| **错误记忆** | 遇到的错误 + 解决方案 | `~/.gclm-flow/memory/errors/` | 避免重复犯错 |
| **模式记忆** | 成功的代码模式 | `~/.gclm-flow/memory/patterns/` | 代码复用 |
| **决策记忆** | 重要的技术决策 | 项目 `llmdoc/reference/` | 决策追溯 |
| **惯例记忆** | 项目特定约定 | 项目 `llmdoc/reference/` | 保持一致性 |

---

## 存储结构

```
~/.gclm-flow/
├── memory/                        # 记忆系统
│   ├── errors/                    # 错误记忆（按语言）
│   │   ├── java.json
│   │   ├── python.json
│   │   ├── go.json
│   │   ├── rust.json
│   │   └── frontend.json
│   │
│   ├── patterns/                  # 模式记忆（按类型）
│   │   ├── api-design.json        # API 设计模式
│   │   ├── error-handling.json    # 错误处理模式
│   │   ├── testing.json           # 测试模式
│   │   └── security.json          # 安全模式
│   │
│   └── index.json                 # 索引文件
│
├── cache/                         # 缓存系统
│   └── projects.json              # 项目检测缓存索引
│
└── config.json                    # gclm-flow 配置
```

---

## 数据格式

### 错误记忆格式

```json
{
  "id": "err-20260225-001",
  "timestamp": "2026-02-25T14:30:00Z",
  "language": "python",
  "framework": "fastapi",
  "error": {
    "type": "ImportError",
    "message": "cannot import name 'Depends' from 'fastapi'",
    "location": "src/api/routes.py:15"
  },
  "context": {
    "task": "添加用户认证接口",
    "related_files": ["src/api/routes.py", "src/services/auth.py"]
  },
  "solution": {
    "description": "循环导入问题，使用延迟导入解决",
    "actions": [
      "将导入语句移到函数内部",
      "重构模块结构，减少耦合"
    ],
    "code_reference": "src/api/routes.py:15-20"
  },
  "occurrences": 2,
  "last_occurred": "2026-02-25T14:30:00Z",
  "tags": ["import", "circular-dependency", "fastapi"]
}
```

### 模式记忆格式

```json
{
  "id": "pat-20260225-001",
  "timestamp": "2026-02-25T15:00:00Z",
  "type": "api-design",
  "language": "java",
  "framework": "springboot",
  "name": "统一响应格式",
  "description": "所有 API 返回统一的响应结构",
  "pattern": {
    "structure": "ApiResponse<T>",
    "fields": ["success", "data", "error", "timestamp"],
    "example_reference": "src/common/ApiResponse.java"
  },
  "when_to_use": [
    "新建 REST API",
    "重构现有 API 响应"
  ],
  "benefits": [
    "前端处理统一",
    "错误处理一致",
    "易于扩展"
  ],
  "usage_count": 15,
  "tags": ["api", "response", "standardization"]
}
```

---

## remember 代理设计

```markdown
---
name: remember
description: 管理长期记忆，包括错误记录、模式提取和知识查询
tools: Read, Write, Edit, Grep, Glob, AskUserQuestion
model: sonnet
---

你是 remember 代理，负责管理项目的长期知识库。

## 职责

1. **记录错误**：当遇到错误并解决后，记录到错误库
2. **提取模式**：从成功的代码中提取可复用的模式
3. **查询记忆**：根据上下文检索相关的历史知识
4. **清理记忆**：定期清理过时或重复的记忆

## 工作流程

### 记录错误
1. 收集错误信息（类型、消息、位置）
2. 分析错误原因和解决方案
3. 检查是否已存在相似错误
4. 如果是新错误，创建记录；如果是重复错误，增加计数

### 提取模式
1. 识别代码中的成功实践
2. 提取模式的结构和使用场景
3. 检查是否已存在相似模式
4. 保存模式并建立索引

### 查询记忆
1. 分析当前任务上下文
2. 搜索相关的错误记录和模式
3. 按相关性排序返回结果
4. 提供使用建议

## 输出格式

### 记录结果
**已记录到记忆库**

- 类型：错误/模式
- ID：xxx-xxx-xxx
- 标签：tag1, tag2
- 相关记忆：2 条

### 查询结果
**找到 X 条相关记忆**

#### 相关错误 (Y 条)
- [err-xxx] 错误描述... (发生 Z 次)
  - 解决方案：...

#### 相关模式 (W 条)
- [pat-xxx] 模式名称...
  - 使用场景：...
```

---

## /gclm:learn 命令设计

### 子命令

| 子命令 | 描述 |
|--------|------|
| `/gclm:learn error` | 记录当前错误和解决方案 |
| `/gclm:learn pattern` | 从代码中提取模式 |
| `/gclm:learn search <关键词>` | 搜索记忆 |
| `/gclm:learn list` | 列出所有记忆 |
| `/gclm:learn stats` | 记忆统计 |
| `/gclm:learn clean` | 清理重复/过时记忆 |

### 使用示例

#### 记录错误
```bash
/gclm:learn error

# 系统会分析最近的错误和修复，提示确认后记录
```

#### 提取模式
```bash
/gclm:learn pattern src/services/auth.py

# 从指定文件或目录提取代码模式
```

#### 搜索记忆
```bash
/gclm:learn search "循环导入"
/gclm:learn search --tag fastapi
/gclm:learn search --lang python
```

#### 查看统计
```bash
/gclm:learn stats

# 输出：
# - 总记忆数：50
# - 错误记忆：30（Java: 10, Python: 12, Go: 8）
# - 模式记忆：20
# - 最近 7 天新增：5
# - 重复错误 TOP 3：...
```

---

## 自动触发机制

### 1. 错误发生时（通过 hooks）

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Bash",
        "hooks": [{
          "type": "command",
          "command": "node scripts/hooks/check-error.js"
        }],
        "description": "检测命令执行错误，触发记忆"
      }
    ]
  }
}
```

### 2. 任务完成时

在 `/gclm:do` 或 `/gclm:fix` 完成后，自动提示：

```
✓ 任务完成

? 是否记录这次经验？
  → 记录错误和解决方案
  → 提取代码模式
  → 跳过
```

### 3. 代码审查时

在 `/gclm:review` 时，自动检查历史错误：

```
正在审查代码...

⚠ 发现历史错误模式：
- [err-xxx] 循环导入问题曾发生 3 次
  当前文件：src/api/routes.py:15
  建议：检查导入结构
```

---

## 与 llmdoc 的关系

| 存储位置 | 内容类型 | 更新频率 | 作用域 |
|----------|----------|----------|--------|
| `llmdoc/` | 项目知识、架构文档 | 手动更新 | 当前项目 |
| `~/.gclm-flow/memory/` | 错误、模式、经验 | 自动积累 | 所有项目 |

### 协作流程

```
1. 新项目开始
   ↓
2. /gclm:init 创建 llmdoc
   ↓
3. 开发过程中
   - memory 自动记录错误和模式
   - llmdoc 记录项目特定知识
   ↓
4. 项目成熟后
   - 从 memory 中提取通用模式到 skills/
   - 项目特定决策记录到 llmdoc/reference/
```

---

## 记忆索引设计

`~/.gclm-flow/memory/index.json`：

```json
{
  "version": "1.0",
  "lastUpdated": "2026-02-25T15:00:00Z",
  "stats": {
    "totalErrors": 30,
    "totalPatterns": 20,
    "byLanguage": {
      "java": { "errors": 10, "patterns": 5 },
      "python": { "errors": 12, "patterns": 8 },
      "go": { "errors": 8, "patterns": 7 }
    }
  },
  "indexes": {
    "byTag": {
      "import": ["err-001", "err-005"],
      "security": ["pat-001", "err-010"]
    },
    "byFramework": {
      "springboot": ["err-001", "pat-001"],
      "fastapi": ["err-005", "pat-003"]
    },
    "recentErrors": ["err-030", "err-029", "err-028"],
    "topPatterns": ["pat-001", "pat-003", "pat-007"]
  }
}
```

---

## 隐私与安全

1. **本地存储**：所有记忆仅存储在本地 `~/.gclm-flow/memory/`
2. **不上传**：记忆数据不会上传到任何服务器
3. **可导出**：支持导出为 JSON 格式，方便备份
4. **可清理**：用户可随时清理特定记忆或全部记忆

```bash
# 导出记忆
/gclm:learn export > my-memory-backup.json

# 清理特定记忆
/gclm:learn clean --older-than 90d

# 清理全部
/gclm:learn clean --all
```
