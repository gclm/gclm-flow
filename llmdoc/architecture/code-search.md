# 代码搜索策略

## 分层回退机制

gclm-flow 实现了三层代码搜索回退策略：

```
┌─────────────────────────────────────────────────────────────┐
│                    代码搜索分层回退                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   用户需要代码上下文                                          │
│          │                                                  │
│          ▼                                                  │
│   ┌──────────────┐                                          │
│   │ auggie 可用? │                                          │
│   └──────┬───────┘                                          │
│          │                                                  │
│    ┌─────┴─────┐                                            │
│    │           │                                            │
│   Yes         No                                            │
│    │           │                                            │
│    ▼           ▼                                            │
│ ┌───────┐  ┌──────────────┐                                 │
│ │语义搜索│  │llmdoc 存在?  │                                 │
│ └───────┘  └──────┬───────┘                                 │
│                  │                                          │
│            ┌─────┴─────┐                                    │
│            │           │                                    │
│           Yes         No                                    │
│            │           │                                    │
│            ▼           ▼                                    │
│     ┌─────────┐  ┌──────────────┐                           │
│     │结构化索引│  │生成 llmdoc   │                           │
│     └────┬────┘  └──────┬───────┘                           │
│          │               │                                  │
│          │          ┌────▼────┐                             │
│          │          │生成完成  │                             │
│          │          └────┬────┘                             │
│          └───────┬──────┘                                   │
│                  ▼                                          │
│         ┌─────────────────┐                                 │
│         │需要更多细节?     │                                 │
│         └────────┬─────────┘                                 │
│                  │                                          │
│            ┌─────┴─────┐                                    │
│            │           │                                    │
│           Yes         No                                    │
│            │           │                                    │
│            ▼           ▼                                    │
│      ┌─────────┐  ┌─────────┐                              │
│      │Grep/Glob│  │返回结果  │                              │
│      └─────────┘  └─────────┘                              │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 三层搜索策略

### Layer 1: auggie (语义搜索) - 推荐

**描述**: 自然语言代码搜索工具

**安装**:
```bash
npm install -g @augmentcode/auggie@prerelease
```

**优势**:
- 语义理解，自然语言查询
- 高精度搜索结果
- 代码上下文增强

**状态**: 可选但强烈推荐

**检测**:
```bash
which auggie 2>/dev/null && echo "AUGGIE_AVAILABLE" || echo "AUGGIE_NOT_FOUND"
```

---

### Layer 2: llmdoc (结构化索引) - 默认

**描述**: LLM 优化的项目文档

**结构**:
```
llmdoc/
├── index.md              # 导航入口
├── overview/             # 项目概览
├── architecture/         # 系统设计
├── guides/               # 操作指南
└── reference/            # API 规范
```

**优势**:
- 结构化索引
- 模块关系图
- 快速定位

**生成**: 自动生成，无需用户确认

---

### Layer 3: Grep/Glob (模式匹配) - 备选

**描述**: 基础文本搜索工具

**工具**:
- `grep` - 内容搜索
- `find` - 文件搜索
- `Glob` - 模式匹配

**优势**:
- 本地工具，无需依赖
- 灵活的模式匹配

**劣势**:
- 精度较低
- 需要精确关键词

---

## 搜索方法对比

| 方法 | 精度 | 速度 | 状态 | 依赖 |
|:---:|:---:|:---:|:---:|:---|
| **auggie** | 高 | 快 | 推荐 | 外部服务 |
| **llmdoc** | 中 | 快 | 默认 | 本地文档 |
| **Grep** | 低 | 慢 | 备选 | 无 |

---

## 使用流程

### Phase 0: llmdoc Reading

1. **检查 auggie**:
   ```bash
   which auggie
   ```

2. **检查 llmdoc**:
   ```bash
   ls llmdoc/
   ```

3. **自动生成** (如不存在):
   - 使用 `investigator` agent 扫描代码库
   - 生成基础文档

4. **读取文档**:
   - `llmdoc/index.md`
   - `llmdoc/overview/*.md`
   - 相关架构文档

---

## Agent 搜索策略

### investigator Agent

**优先级**: auggie → llmdoc → Grep

**实现**:
```bash
# 1. 尝试 auggie
auggie "用户认证相关的代码"

# 2. 回退到 llmdoc
cat llmdoc/architecture/workflow.md

# 3. 补充 Grep
grep -r "authenticate" --include="*.ts"
```

---

## Phase 2 并行探索

由于 `Explore` agent 不支持 auggie 策略，Phase 2 使用模式匹配：

| Agent | 搜索方法 | 权衡 |
|:---|:---|:---|
| Agent 1 (相似功能) | Glob + Grep | 牺牲策略换速度 |
| Agent 2 (架构映射) | Glob + Read | 牺牲策略换速度 |
| Agent 3 (代码规范) | Grep + Glob | 牺牲策略换速度 |

**设计决策**: Phase 2 探索阶段可以牺牲一些精度换取真正的并行速度

---

## 最佳实践

1. **安装 auggie**: 获得最佳搜索体验
2. **维护 llmdoc**: 定期更新项目文档
3. **合理选择**: 根据场景选择搜索方法
4. **组合使用**: 多种方法结合使用
