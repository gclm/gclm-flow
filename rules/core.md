# 核心规则

所有项目通用的编码规范和最佳实践。

## 通用原则

### 1. 代码质量
- 保持代码简洁清晰
- 遵循 SOLID 原则
- DRY (Don't Repeat Yourself)
- KISS (Keep It Simple, Stupid)

### 2. 命名规范
- 使用有意义的名称，避免缩写
- 类名使用 PascalCase
- 函数/变量使用 camelCase 或 snake_case（根据语言）
- 常量使用 UPPER_CASE
- 布尔变量使用 is/has/can 前缀

### 3. 注释规范
- 解释"为什么"而非"是什么"
- 保持注释与代码同步
- 使用文档注释记录公共 API
- 避免注释掉的代码

### 4. 函数规范
- 单一职责原则
- 函数长度不超过 50 行
- 参数数量不超过 4 个
- 避免嵌套超过 3 层

## 安全规范

### 1. 输入验证
- 永远不要信任用户输入
- 在边界层验证所有输入
- 使用白名单验证
- 转义特殊字符

### 2. 认证授权
- 使用成熟的认证框架
- 密码必须加密存储
- 使用安全的会话管理
- 实施最小权限原则

### 3. 敏感数据
- 不在日志中记录敏感信息
- 不在 URL 中传递敏感数据
- 使用环境变量存储密钥
- 加密传输和存储

### 4. 常见漏洞防护
- SQL 注入：使用参数化查询
- XSS：转义输出
- CSRF：使用 CSRF Token
- 路径遍历：验证文件路径

## 性能规范

### 1. 数据库
- 使用索引优化查询
- 避免 N+1 查询
- 使用连接池
- 分页查询大数据集

### 2. 缓存
- 缓存频繁访问的数据
- 设置合理的过期时间
- 使用多级缓存
- 考虑缓存穿透/雪崩

### 3. 并发
- 使用异步处理耗时操作
- 避免阻塞操作
- 使用连接池
- 合理设置超时

## 测试规范

### 1. 单元测试
- 测试公共接口
- 使用有意义的测试名称
- 遵循 AAA 模式（Arrange-Act-Assert）
- 保持测试独立性

### 2. 测试覆盖率
- 目标覆盖率：80%
- 关键路径必须覆盖
- 边界条件必须测试
- 错误处理必须测试

### 3. 测试数据
- 使用工厂模式创建测试数据
- 不依赖外部服务
- 清理测试数据

## 错误处理

### 1. 异常处理
- 捕获特定异常
- 不吞掉异常
- 记录完整的错误信息
- 提供有意义的错误消息

### 2. 日志规范
- 使用日志级别（DEBUG/INFO/WARN/ERROR）
- 包含上下文信息
- 结构化日志格式
- 不记录敏感信息

### 3. 错误响应
- 返回一致的错误格式
- 包含错误代码和消息
- 不暴露内部实现细节
- 提供解决建议

## 工具使用规范

### 1. 敏感命令预授权
以下命令类型**必须在执行前**使用 AskUserQuestion 请求用户授权：

| 命令类型 | 示例 | 说明 |
|---------|------|------|
| 远程连接 | `ssh`, `scp`, `rsync` | 连接远程服务器 |
| 特权提升 | `sudo`, `su`, `doas`, `pkexec` | 以更高权限执行 |
| 网络调试 | `telnet`, `nc` | 网络连接测试 |
| 进程管理 | `kill`, `killall`, `pkill` | 终止进程 |

**请求格式：**
```
问题：需要执行 [命令类型]，是否授权？
选项：
- 授权执行
- 拒绝
```

## Git 规范

### 1. 提交信息
```
<type>(<scope>): <subject>

<body>

<footer>
```

类型：
- feat: 新功能
- fix: 修复
- refactor: 重构
- docs: 文档
- test: 测试
- chore: 杂项

### 2. 分支策略
- main: 生产分支
- develop: 开发分支
- feature/*: 功能分支
- hotfix/*: 热修复分支

### 3. 代码审查
- 所有代码变更需要审查
- 检查代码质量、安全、性能
- 确保测试通过
- 检查文档更新
